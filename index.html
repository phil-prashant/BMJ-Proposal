<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BMJ Proposal Application</title>
  <style>
    /* Basic CSS and responsive styling for inputs/buttons */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f2f7fa;}
    header { background: #142850; color: #fff; padding: 2em 1em;}
    .container { max-width: 820px; margin: auto; background: #fff; border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,64,0.07); padding: 2em; margin-top: -40px;}
    h1, h2 { margin-top: 0; }
    .package-options, .addon-options, .payment-options { display: flex; gap: 1em; margin-bottom: 2em; flex-wrap: wrap;}
    .option-card { background: #e6ecf0; border-radius: 8px; padding: 1em; min-width: 220px; flex: 1; }
    .option-card input[type="radio"], .option-card input[type="checkbox"] { width: 22px; height: 22px; margin-right: 0.6em; vertical-align: middle;}
    .addon-options .option-card { min-width: 180px;}
    .actions { display: flex; gap:1em; margin: 1.5em 0; flex-wrap: wrap;}
    .actions button { padding: .7em 1.5em; border-radius: 5px; border: none; font-weight: bold; cursor: pointer;}
    .actions button[disabled] { background: #ddd; color:#aaa; cursor:not-allowed;}
    .sticky-header { position: sticky; top:0; background:#142850; color:#fff; padding:0.8em 1em; z-index:999; border-bottom:2px solid #249cff;}
    .summary { margin:1em 0 2em 0; padding:1em; background:#f0f6ff; border-radius:8px;}
    @media (max-width: 650px) { .container { padding:.7em;} header, .sticky-header { padding:1em 0.6em;} .package-options, .addon-options, .payment-options { flex-direction: column;} }
  </style>
</head>
<body>
  <header>
    <h1>BMJ-Machinery Proposal Builder</h1>
    <p>
      Dear Eric / Chi Feng, use this custom dashboard to select the best package, add-ons, and the payment frequency for BMJ-Machinery's growth. Select a package below, choose add-ons, review pricing, and finalize your proposal. The "Finalize Choices" button will lock your selections and enable the Email Proposal button after you agree to Terms & Conditions.
    </p>
  </header>
  <div class="sticky-header">
    <span id="outcome-metrics"></span>
    <span id="total-pricing" style="float:right;"></span>
  </div>
  <div class="container">

    <h2>1. Select Base Package</h2>
    <div class="package-options" id="packageOptions">
      <div class="option-card">
        <input type="radio" id="p1" name="package" value="5500" />
        <label for="p1">Lead Accelerator<br><small>$5,500/month</small></label>
      </div>
      <div class="option-card">
        <input type="radio" id="p2" name="package" value="7800" />
        <label for="p2">Growth Booster<br><small>$7,800/month</small></label>
      </div>
      <div class="option-card">
        <input type="radio" id="p3" name="package" value="8900" />
        <label for="p3">Market Domination (Premium)<br><small>$8,900/month <b>(Best Value)</b></small></label>
      </div>
    </div>

    <h2>2. Choose Add-Ons</h2>
    <div class="addon-options" id="addonOptions">
      <div class="option-card">
        <input type="checkbox" class="addon" data-price="400" id="add1" disabled />
        <label for="add1">Press Release Distribution (any 2 countries & 5 industries)</label>
      </div>
      <div class="option-card">
        <input type="checkbox" class="addon" data-price="750" id="add2" disabled />
        <label for="add2">Advanced Analytics Setup</label>
      </div>
      <div class="option-card">
        <input type="checkbox" class="addon" data-price="550" id="add3" disabled />
        <label for="add3">Copywriting Service</label>
      </div>
      <div class="option-card">
        <input type="checkbox" class="addon" data-price="900" id="add4" disabled />
        <label for="add4">Dedicated Campaign Manager</label>
      </div>
      <div class="option-card">
        <input type="checkbox" class="addon" data-price="280" id="add5" disabled />
        <label for="add5">Quarterly Performance Reviews</label>
      </div>
      <div class="option-card">
        <input type="checkbox" class="addon" data-price="970" id="add6" disabled />
        <label for="add6">SEO Optimization</label>
      </div>
      <div class="option-card">
        <input type="checkbox" class="addon" data-price="750" id="add7" disabled />
        <label for="add7">Multi-channel Outreach</label>
      </div>
    </div>

    <h2>3. Set Payment Frequency</h2>
    <div class="payment-options" id="paymentOptions">
      <div class="option-card">
        <input type="radio" name="paymentTerm" id="pt1" value="Monthly" disabled />
        <label for="pt1">Monthly (0% discount)</label>
      </div>
      <div class="option-card">
        <input type="radio" name="paymentTerm" id="pt2" value="Quarterly" disabled />
        <label for="pt2">Quarterly (5% discount)</label>
      </div>
      <div class="option-card">
        <input type="radio" name="paymentTerm" id="pt3" value="Half-Yearly" disabled />
        <label for="pt3">Half-Yearly (10% discount)</label>
      </div>
      <div class="option-card">
        <input type="radio" name="paymentTerm" id="pt4" value="Annually" disabled />
        <label for="pt4">Annually (15% discount)</label>
      </div>
    </div>

    <h2>4. Review, Finalize & Email</h2>
    <div class="summary" id="proposalSummary"></div>

    <div class="actions">
      <button id="clearBtn">Clear Selections</button>
      <button id="finalizeBtn" disabled>Finalize Choices</button>
      <input type="checkbox" id="termsCheck" />
      <label for="termsCheck">I have reviewed and agree to the Terms & Conditions</label>
      <button id="emailBtn" disabled>Email Detailed Proposal</button>
    </div>
  </div>
  <!-- Modal for email entry -->
  <div id="emailModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;
    background:rgba(30,60,150,.13);z-index:9999;align-items:center;justify-content:center;">
    <form id="emailForm" style="background:#fff;padding:2em;border-radius:8px;box-shadow:0 6px 24px rgba(56,56,96,0.09);width:320px;">
      <label for="recipientEmail">Recipient Email</label><br />
      <input type="email" id="recipientEmail" style="width:100%;margin-bottom:1em;" required><br />
      <button id="sendEmailBtn" type="submit">Send Proposal</button>
      <button id="closeModal" type="button" style="margin-top:10px;">Cancel</button>
    </form>
  </div>
  <script>
    // JS chain of thoughts: holds state, validates, updates UI

    // State
    let selectedPackage = null;
    let addOns = [];
    let selectedPayment = null;
    let proposalFinalized = false;

    // Elements
    const packageRadios = document.querySelectorAll('input[name="package"]');
    const addonCheckboxes = document.querySelectorAll('.addon');
    const paymentRadios = document.querySelectorAll('input[name="paymentTerm"]');
    const clearBtn = document.getElementById("clearBtn");
    const finalizeBtn = document.getElementById("finalizeBtn");
    const termsCheck = document.getElementById("termsCheck");
    const emailBtn = document.getElementById("emailBtn");
    const summaryDiv = document.getElementById("proposalSummary");
    const outcomeMetrics = document.getElementById("outcome-metrics");
    const totalPricing = document.getElementById("total-pricing");

    // Enable add-ons only after base package selection
    packageRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        selectedPackage = Number(radio.value);

        // Enable add-ons and payment terms
        addonCheckboxes.forEach(cb => cb.disabled = false);
        paymentRadios.forEach(pt => pt.disabled = false);

        finalizeBtn.disabled = false;
        updateSummary();
        updatePricing();
        deselectAddons();
      });
    });

    // Add-ons and payment change handlers
    addonCheckboxes.forEach(cb => {
      cb.addEventListener("change", updateSummary);
      cb.addEventListener("change", updatePricing);
    });

    paymentRadios.forEach(pt => {
      pt.addEventListener("change", () => {
        selectedPayment = pt.value;
        updateSummary();
        updatePricing();
      });
    });

    // Finalize selections
    finalizeBtn.addEventListener("click", () => {
      proposalFinalized = true;
      finalizeBtn.disabled = true;
      addonCheckboxes.forEach(cb => cb.disabled = false);
      paymentRadios.forEach(pt => pt.disabled = false);
      termsCheck.focus();
      window.scrollTo({top: termsCheck.offsetTop - 24, behavior:'smooth'});
      updateEmailButtonState();
    });

    // Terms checkbox
    termsCheck.addEventListener("change", updateEmailButtonState);

    // Email button logic: must finalize + agree terms
    function updateEmailButtonState() {
      emailBtn.disabled = !(proposalFinalized && termsCheck.checked);
    }
    emailBtn.addEventListener("click", () => {
      document.getElementById("emailModal").style.display = "flex";
      document.getElementById("recipientEmail").value = "";
    });

    // Email modal logic
    document.getElementById("closeModal").addEventListener("click", () => {
      document.getElementById("emailModal").style.display = "none";
    });

    document.getElementById("emailForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const recipientEmail = document.getElementById("recipientEmail").value;
      emailBtn.disabled = true;
      const options = {
        package: selectedPackage,
        addOns: getSelectedAddons(),
        payment: selectedPayment,
        summary: summaryDiv.innerText
      };
      await sendProposal(options, recipientEmail);
      emailBtn.disabled = false;
      document.getElementById("emailModal").style.display = "none";
      alert('Proposal sent successfully!');
    });

    // Clear Selections
    clearBtn.addEventListener("click", () => {
      selectedPackage = null;
      addOns = [];
      selectedPayment = null;
      proposalFinalized = false;
      packageRadios.forEach(r => r.checked = false);
      deselectAddons();
      paymentRadios.forEach(p => p.checked = false);
      addonCheckboxes.forEach(cb => cb.disabled = true);
      paymentRadios.forEach(pt => pt.disabled = true);
      finalizeBtn.disabled = true;
      termsCheck.checked = false;
      emailBtn.disabled = true;
      updateSummary();
      updatePricing();
    });
    function deselectAddons() { addonCheckboxes.forEach(cb => cb.checked = false); }
    function getSelectedAddons() {
      return Array.from(addonCheckboxes).filter(cb => cb.checked).map(cb => cb.nextElementSibling.innerText.trim());
    }

    // Update pricing and metrics
    function updatePricing() {
      let base = selectedPackage || 0;
      let addons = Array.from(addonCheckboxes).filter(cb => cb.checked).map(cb=>Number(cb.getAttribute('data-price'))).reduce((a,b)=>a+b,0);
      let discount = 0;
      let paymentText = "";
      if (selectedPayment === 'Quarterly') { discount = .05; paymentText = "Quarterly"; }
      else if (selectedPayment === 'Half-Yearly') { discount = .10; paymentText = "Half-Yearly"; }
      else if (selectedPayment === 'Annually') { discount = .15; paymentText = "Annually"; }
      else { paymentText = "Monthly"; }
      let subtotal = base + addons;
      let discountAmt = subtotal * discount;
      let total = subtotal - discountAmt;
      totalPricing.innerText = "Total: $" + total.toFixed(0) + " / " + paymentText;

      let outcomeStr = selectedPackage ? 
        `Prospects reached/month: ${Math.round(selectedPackage/10)+100}` : "";
      outcomeMetrics.innerText = outcomeStr;
    }

    function updateSummary() {
      summaryDiv.innerHTML = `
        <b>Package:</b> ${selectedPackage ? "$" + selectedPackage : "(none selected)"}<br>
        <b>Add-Ons:</b> ${getSelectedAddons().join(", ") || "(none)"}<br>
        <b>Payment Term:</b> ${selectedPayment || "(none selected)"}<br>
      `;
    }

    // Email sending (uses public backend API)
    async function sendProposal(options, recipientEmail) {
      const response = await fetch('https://bmj-sendgrid-service.onrender.com/api/send-proposal', {
        method: "POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          ...options,
          recipientEmail
        })
      });
      return response.json();
    }

    // Initialize view at page load
    clearBtn.click();
  </script>
</body>
</html>
